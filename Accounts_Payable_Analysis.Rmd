---
title: "Accounts Payable Data Analysis using MySQL and R"
author: "By Njabulo Hlabangana"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This one of my favorite projects for the simple reason that it involves the use of two of my favorite data tools - R (markdown) and SQL. I connected my MySQL database to R studio and used R markdown to run SQL queries. The queries were then analysed and visualized using the ggplot2 package.

The MySQL database contains accounts payable data and was obtained from Murach's MySQL textbook resources that I have used a lot to learn SQL.

```{r, warning=FALSE, message=FALSE}
library(odbc)
library(RMySQL)
library(tidyverse)
library(ggeasy)
con = dbConnect(RMySQL::MySQL(),
                            dbname='ap',
                            host='localhost',
                            port=3306,
                            user='root',
                            password='Magalela@777')

```


## The AP database
The following line codes shows the list of tables in the ap database that this analysis is based on.
```{r}
dbListTables(con)
```

This rather simple analysis is based on only 4 of the tables in the database viz, invoices, vendors, terms and line_items. 

### The Invoices Table

The line of SQL code below extracts the **invoices** table and saves it as an R data frame named **invoices** 

```{sql, connection = con, output.var = "invoices"}
SELECT *
FROM invoices
```

This is what the **invoices** table looks like after being converted to an R dataframe.
```{r, warning = FALSE, message = FALSE}
head(invoices)
```

### The Vendors Table
The line extracts all the columns of the vendors table and saves them in a dataframe named vendors
```{sql, connection = con, output.var = "vendors"}
SELECT *
FROM vendors
```

This is what the **vendors** table looks like as a data frame
```{r}
head(vendors)
```


### The Terms Table

Now we extract the **terms** table from the database using a similar line of SQL  code.

```{sql, connection = con, output.var = "terms"}
SELECT*
FROM terms
```

The **terms** table is shown below.
```{r}
head(terms)
```

## Analysis of Expenditure by Vendor, State & Credit Terms

The aim of the SQL querry below is to find the total value of all the invoices in the accounts payable database. This total is broken down by vendors and the credit terms they have for the organization. The results of the query are saved in a data frame called M1_results.

```{sql, connection = con, output.var = "M1_results"}
SELECT 
vendor_name, 
terms_description,
vendor_state,
sum(invoice_total) as total_amount

FROM
invoices i
JOIN vendors v
ON i.vendor_id = v.vendor_id
JOIN terms t
ON t.terms_id = i.terms_id 

GROUP BY vendor_name, terms_description, vendor_state
ORDER BY total_amount DESC
LIMIT 10

```

The first 6 rows of the M1_results are shown below.
```{r, warning = FALSE, message = FALSE}
head(M1_results)
```

### Visualization of Expenditure By Vendor & Credit Terms

Only the top 10 vendors by total invoice value are shown in the graph below. 7 out of those 10 offer 30 day payment terms. There is one dominant vendor - Malloy Lithographing Inc. The total invoice amount for this vendor is more than 5 times that of the second largest vendor.

```{r, warning = FALSE, message = FALSE}
ggplot(M1_results, aes(x = reorder(vendor_name,-total_amount), total_amount, fill = terms_description)) +
  geom_col()+
  xlab("Vendor Name")+
  labs(title = "Invoice Total By Vendor (Top 10 Vendors)")+
  ggeasy::easy_center_title()+
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
  
```

### Visualization of Expenditure By Vendor and Vendor State

Of the top 10 vendors, 5 are from the state of California. The combined invoice total of these vendors is, however, less than the total of the two vendors from the state of Miami which is where the dominant vendor is located.

```{r}
ggplot(M1_results, aes(x = reorder(vendor_name,-total_amount), total_amount, fill = vendor_state)) +
  geom_col()+
  xlab("Vendor Name")+
  labs(title = "Invoice Total By Vendor (Top 10 Vendors)")+
  ggeasy::easy_center_title()+
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
  
```


### An Economic Perspective On Supplier (vendor) Dominance

Seeing from the graphs above that the organization seems to be buying mainly from a few vendors, I decided to ascertain the degree of diversification of its vendor base. As someone with a background in economics, I figured the **Gini Coefficient** would be a good indicator to use. It is mainly used to measure the degree of income inequality in society. It is also used in industrial organization and microeconomics to estimate the degree of market concentration when studying market structure. 

The gini coefficient takes values between 0 and 1. A higher value indicates high inequality. In the case of inequality measurement a high value would indicate high inequality - a society in which income is concentrated in the hands of a few people. In the case of market structure study, a high value would be an indicator that a particular market is dominated by a very few dominant players.

The Lorenz curve is used to display the distribution of invoice total among vendors. The gini coefficient is also displayed on the curve.


```{r, warning = FALSE, message = FALSE}
library(REAT)
lorenz(M1_results$total_amount,lcx = "% of Vendors", lcy = "% of Invoice Amount",
       le.col = "green", lc.col = "red", lctitle = "Vendors Lorenz Curve", lcgn = TRUE )
```

The high value of the gini coefficient **(0.722)** for this organization shows that it is relying on a few vendors for its supplies. This may be a risky arrangement because any supply chain disruptions that affect the dominant vendors could have serous repercussions on its operations and profitability. 


## Line Item Analysis

The aim here is to breakdown invoice total value by line item in a bid to understand how expenditure is spread among the items (products/services)

```{sql, connection = con, output.var = "line_items"}
SELECT
line_item_description as line_item,
SUM(line_item_amount) as amount

FROM
invoice_line_items

GROUP BY line_item
ORDER BY amount DESC
LIMIT 10
```

```{r,warning = FALSE, warning = FALSE}
head(line_items)
ggplot(line_items, aes(x = reorder(line_item,-amount), amount, fill = line_item)) +
  geom_col()+
  xlab("Line Item")+
  labs(title = "Invoice Total By Line Item(Top 10 items)")+
  ggeasy::easy_center_title()+
  theme(axis.text.x = element_text(angle = 45,hjust = 1),legend.position = "none")

```


## Analysis of Invoice Payment Status

This part seeks to understand the payment status of invoices in the AP database. The status is broken down into 3 categories with self-explanatory titles - **Paid on Time, Late Payment and Outstanding Payment**. The SQL code is shown below.

```{sql, connection = con, output.var = "Payment_Status"}
SELECT 
sum(invoice_total) as amount,
CASE
	WHEN payment_date > invoice_due_date THEN "Late Payment"
	WHEN payment_date <= invoice_due_date THEN "Paid on time"
	ELSE "Outstanding"
END AS payment_status

FROM invoices
GROUP BY payment_status
ORDER BY amount DESC
```


## Payment Statement Visualization 

The pie chart below visualizes the proportions of the different payment statuses in the database. 

```{r,warning = FALSE, warning = FALSE}

head(Payment_Status)

pie(Payment_Status$amount,Payment_Status$payment_status, main = "Invoice Total Breakdown By Payment Status")
```



This visualization indicates that the organization pays most of its vendors late. This could be a cash-flow management strategy which could potentially affect its relationship with its vendors. 
